<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Wilson Center - Mineral Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<style>
    .rounded-rect {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 50px -25px black;
    }

    .flex-center {
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .flex-center.left {
        left: 0px;
    }

    .flex-center.right {
        right: 0px;
    }

    .sidebar-content {
        position: absolute;
        width: 100%;
        height: 100%;
        font-family: Arial, Helvetica, sans-serif;
        color: #333;
    }
    
    .sidebar-content-inner{
        width: 100%;
        padding: 1.6rem;
        text-align: -webkit-right;
        
    }

    .sidebar-toggle {
        position: absolute;
        width: 1.3em;
        height: 1.3em;
        overflow: visible;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sidebar-toggle.left {
        right: -1.5em;
        font-size: 32px;
    }

    .sidebar-toggle.close {
        font-size: 32px;
        position: relative; 
        right: 0;
}

    .sidebar-toggle:hover {
        color: #0aa1cf;
        cursor: pointer;
    }

    .sidebar {
        transition: transform 1s;
        z-index: 1;
        width: 400px;
        height: 100%;
    }
    
    .sidebar-selection{
        color:DarkGray;
    }
    

    /*
  The sidebar styling has them "expanded" by default, we use CSS transforms to push them offscreen
  The toggleSidebar() function removes this class from the element in order to expand it.
*/
    .left.collapsed {
        transform: translateX(-395px);
    }

    .right.collapsed {
        transform: translateX(395px);
    }
    
    
/*    table*/
.infoTable  {border-collapse:collapse;border-spacing:0;border:none;width: 100%}
.infoTable td{font-size:14px;}
  overflow:hidden;padding:10px 5px;word-break:normal;}
.infoTable th{font-size:16px;font-weight:bold;overflow:hidden;padding:10px 5px;text-align:center; line-height: 12px;}
.infoTable thead{line-height: 15px;}
.infoTable .left-th{text-align:left}
.infoTable .col2{text-align:right;vertical-align:bottom;padding:5px}
.infoTable .col1{text-align:left;vertical-align:top;padding:5px}
.infoTable .numeric{text-align:right;vertical-align:bottom;padding:5px}

/*    end table */
    
/*    legend dots */
    
    #dot_cobalt{color:#79a2be}
    #dot_copper{color:#CD5C5C}
    #dot_lithium{color:mediumpurple}
    #dot_nickel{color:orange}
    #dot_rare{color:#7db698}
    
/*    end ledeng dots*/
    
    
    
</style>

<div id="map">
    <div id="left" class="sidebar flex-center left collapsed">
        <div class="sidebar-content rounded-rect flex-center">

            <div class="sidebar-content-inner" >
                <div id="close-sidebar-button" class="sidebar-toggle close" onclick="toggleSidebar('left')">
                X
            </div>
                
                <img src="img/Wilson%20Center%20-%20Supply%20Chain%20Initiative.svg" alt="Winsol Center Logo"><hr>
            <table class="infoTable">
            <thead>
              <tr>
                <th class="left-th">MINERAL</th>
                <th>WORLD TOTAL</th>
                <th>SELECTED<br>COUNTRY<br><span id="hover_county" style="font-style:italic">Click on a country</span></th>
              </tr>
            </thead>
            <tbody>
              <tr id="sidebar-Cobalt-row">
                <td class="col1"><input type="checkbox" id="Cobalt_cb" onclick="mineralToggle('Cobalt'),''" checked><span style="font-weight:bold"><span id="dot_cobalt">&#11044; </span>Cobalt</span>
                    <br>Reserves
                    <br>Processing<br>
                <td class="col2">7,128,000 mt<br>131,434 mt<br></td>
                <td class="numeric"><span id="selected_CobaltReserves"></span><br><span id="selected_CobaltProcessing"></span></td>
              </tr>
              <tr id="sidebar-Copper-row">
                <td class="col1"><input type="checkbox" id="Copper_cb" onclick="mineralToggle('Copper'),''" checked><span style="font-weight:bold"><span id="dot_copper">&#11044; </span>Copper</span><br>Reserves<br>Refining</td>
                <td class="numeric">871,000 kt<br>23,615 kt</td>
                  <td class="numeric"><span id="selected_CopperReserves"></span><br><span id="selected_CopperProcessing"></span><span id="selected_CopperRefining"></span></td>
              </tr>
              <tr id="sidebar-Lithium-row">
                <td class="col1"><input type="checkbox" id="Lithium_cb" onclick="mineralToggle('Lithium'),''" checked><span style="font-weight:bold"><span id="dot_lithium">&#11044; </span>Lithium</span><br>Reserves<br>Processing<br>
                <td class="numeric">21,055,000 mt<br>350,020 mt</td>
                <td class="numeric"><span id="selected_LithiumReserves"></span><br><span id="selected_LithiumProcessing"></span></td>
              </tr>
              <tr id="sidebar-Nickel-row">
                <td class="col1"><input type="checkbox" id="Nickel_cb" onclick="mineralToggle('Nickel'),''" checked><span style="font-weight:bold"><span id="dot_nickel">&#11044; </span>Nickel</span><br>Reserves<br>Refining</td>
                <td class="numeric"> 93,900,000 kt<br>2,414 kt</td>
                <td class="numeric"><span id="selected_NickelReserves"></span><br><span id="selected_NickelProcessing"></span><span id="selected_NickelRefining"></span></td>
              </tr>
              <tr id="sidebar-Rare Earth-row">
                <td class="col1"><input type="checkbox" id="Rare Earth_cb" onclick="mineralToggle('Rare Earth'),''" checked><span style="font-weight:bold"><span id="dot_rare">&#11044; </span>Rare Earth</span><br>Reserves<br>Refining</td>
                <td class="numeric"> 115,820,000 mt<br>46,095 kt</td>
                <td class="numeric"><span id="selected_Rare EarthReserves"></span><br><span id="selected_Rare EarthProcessing"></span><span id="selected_Rare EarthRefining"></span></td>
              </tr>
              <tr>
                  <input type="checkbox" id="Reserves_cb" onclick="mineralToggle('','Reserves')" checked>Reserves
                  <input type="checkbox" id="Processing_cb" onclick="mineralToggle('','Processing')" checked>Processing
                  <input type="checkbox" id="Refining_cb" onclick="mineralToggle('','Refining')" checked>Refining
                  
              </tr>
                
                
            </tbody>
            </table>
            </div>
<!--            expand/collapse arrow-->
            <div id="expand-sidebar-button" class="sidebar-toggle rounded-rect left" onclick="toggleSidebar('left')">
                &rarr;
            </div>
        </div>
    </div>
<!--
    <div id="right" class="sidebar flex-center right collapsed">
        <div class="sidebar-content rounded-rect flex-center">
            Right Sidebar
            <div class="sidebar-toggle rounded-rect right" onclick="toggleSidebar('right')">
                &larr;
            </div>
        </div>
    </div>
-->
</div>

<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoibWFyeWRhbWljbyIsImEiOiJjbDNsbWl6cTEwcWFlM2Jycm1lZjk2eGEyIn0.ZACbACYA25TGUS4jUSrV6A';
    const center = [0, 0];
    const bounds = [
        [-160, -90], // Southwest coordinates
        [160, 90] // Northeast coordinates
    ];
    const map = new mapboxgl.Map({
        container: 'map',
        zoom: 0,
        center: center,
        maxZoom: 2.5,
        minZoom: 0,
        maxBounds: bounds,
        style: 'mapbox://styles/marydamico/cl3mk4ulw000714rvav214y90'
    });

    // Minral list within map
    var displayMinerals = ["Copper", "Cobalt", "Nickel", "Lithium", "Rare Earth"];
    var displayMineralType = ["Reserves", "Refining", "Processing"];

    // sidebar slide functionality
    function toggleSidebar(id) {
        const elem = document.getElementById(id);
        const sb_button = document.getElementById("expand-sidebar-button");
        // Add or remove the 'collapsed' CSS class from the sidebar element.
        // Returns boolean "true" or "false" whether 'collapsed' is in the class list.
        const collapsed = elem.classList.toggle('collapsed');
        const padding = {};
        // 'id' is 'right' or 'left'. When run at start, this object looks like: '{left: 300}';
        padding[id] = collapsed ? 0 : 300; // 0 if collapsed, 300 px if not. This matches the width of the sidebars in the .sidebar CSS class.
        collapsed ?  sb_button.style.display = "flex" : sb_button.style.display = "none"; // display button if collapsed, hide if not.
        
        
        
        // Use `map.easeTo()` with a padding option to adjust the map's center accounting for the position of sidebars.
        map.easeTo({
            padding: padding,
            duration: 1000 // In ms. This matches the CSS transition duration property.
        });
    }
    
    
    map.on('load', () => {
        toggleSidebar('left'); //starts sidebar closed
        const countryDisplay = document.getElementById('hover_county');
        
//        populateWorldTotals();  TO AUTOMATE!
        
        map.on('click', function(e) {
//            let l = map.getStyle().layers; // get all the layers of the style
//             console.log(l)
             
             // clear panel
             document.getElementById('hover_county').innerHTML = "&nbsp"
             var displayMinerals = ["Copper", "Cobalt", "Nickel", "Lithium", "Rare Earth"];
             for (item of displayMinerals){
                 var elem = document.getElementById("selected_"+item+"Reserves");
                    if(elem !== null && elem !== 'undefined' ) {
                      document.getElementById("selected_"+item+"Reserves").innerHTML = "&nbsp"
                 }
                 elem = document.getElementById("selected_"+item+"Processing");
                    if(elem !== null && elem !== 'undefined' ) {
                      document.getElementById("selected_"+item+"Processing").innerHTML = "&nbsp"
                 }
                 elem = document.getElementById("selected_"+item+"Refining");
                    if(elem !== null && elem !== 'undefined' ) {
                      document.getElementById("selected_"+item+"Refining").innerHTML = "&nbsp"
                    }
                
//                 document.getElementById("selected_"+item+"Reserves").innerHTML = "&nbsp"
//                 document.getElementById("selected_"+item+"Processing").innerHTML = "&nbsp"
//                 document.getElementById("selected_"+item+"Refining").innerHTML = "&nbsp"
            }

            var clickedFeature = map.queryRenderedFeatures(e.point, {
                layers: ['wilsonminerals'] // filter for features in this layer
            }); 
             
            if (typeof clickedFeature[0] !== 'undefined') {
                thisFeatureProps = clickedFeature[0].properties
//                console.log(thisFeatureProps)
                const thisCountry = thisFeatureProps.Country

                // set country label in info panel
                document.getElementById('hover_county').innerHTML = thisCountry


                // get realted data vaues for selected country
                const relatedFeatures = map.querySourceFeatures("composite", {
                    sourceLayer: "WilsonMinerals4-0hbtuj",
                    filter: ['==', 'Country', thisCountry]
                });

                //console.log(relatedFeatures)

                const uniqueFeatures = getUniqueFeatures(relatedFeatures, "country-level");
                console.log(uniqueFeatures);
             }; // end if click is !undefined
          }); // end on click
        
        // Create a popup, but don't add it to the map yet.
        const popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
        });
        
        map.on('mouseenter', 'wilsonminerals', (e) => {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        // Copy coordinates array.
        const coordinates = e.features[0].geometry.coordinates.slice();
            const description = '<b>'+e.features[0].properties.Country + '</b><br><i> Click to view details</i>';

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(coordinates).setHTML(description).addTo(map);
        }); // end on mouseenter

        map.on('mouseleave', 'wilsonminerals', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        }); // end on mouseleave 
        
    }); // end on load
    
    

    
    function mineralToggle(thisMineral,thisType){
        console.log(thisMineral)
        console.log(thisType)
//        console.log(thisMineral+"_cb")
//        console.log(thisMineral+" " + thisType)
        
        // get minerals
        if(thisMineral != ""){
            if(document.getElementById(thisMineral+"_cb").checked == false ) {
                // remove item from array 
                displayMinerals = displayMinerals.filter(function(item) {
                    return item !== thisMineral
                })
                // grey out row in table
                var element = document.getElementById("sidebar-"+thisMineral+"-row");
                element.classList.add("sidebar-selection");
            } else { 
                // add item to array
                displayMinerals.push(thisMineral)
                // darken row in table
                var element = document.getElementById("sidebar-"+thisMineral+"-row");
                element.classList.remove("sidebar-selection");
            }
        }
        
        // get type
       if(typeof thisType !== 'undefined'){
        if(document.getElementById(thisType+"_cb").checked == false ) {
            // remove item from array 
            displayMineralType = displayMineralType.filter(function(item) {
                return item !== thisType
            })
        } else { 
            // add item to array
            displayMineralType.push(thisType)
        }
       }
        
        
        
        // filter map for values in displayMinerals array
        // map.setFilter('wilsonminerals', ['in', 'Mineral'].concat(displayMinerals));   // by mineral type alone 
        var mineralFilter=[
            "all",
            ["in", 'Mineral'].concat(displayMinerals),
            ["in", "Res_Ref_Proc"].concat(displayMineralType),
        ]
        console.log("filtering minerals: " + displayMinerals)
        console.log("filtering type: " + displayMineralType)
        
        map.setFilter('wilsonminerals', mineralFilter)
        
        
        
    };
    

    function getUniqueFeatures(features, scale) {
        const uniqueItems = new Set();


        // Because features come from tiled vector data,
        // feature geometries may be split
        // or duplicated across tile boundaries.
        // As a result, features may appear
        // multiple times in query results.
        const uniqueFeatures = [];
        for (const feature of features){ 
            const concatItem = feature.properties["Mineral"] + feature.properties["Res_Ref_Proc"];
            // check for combo of Country, Mineral, and Resource Type in the list
            if (!uniqueItems.has(concatItem)) {
                uniqueItems.add(concatItem);
                uniqueFeatures.push(feature);
                //console.log(concatItem)
                 if(scale == "country-level"){
                    // add item info to panel
                    var tableValue = feature.properties["Amount"].toLocaleString() + " " + feature.properties["Unit"];
                    tableValue = tableValue.replace("kilotons", "kt"); // update units if found
                    tableValue = tableValue.replace("metric tons", "mt"); // update units if found
                     
                     // populate value if it exists
                     var elem = document.getElementById("selected_"+concatItem);
                        if(elem !== null && elem !== 'undefined' ) {
                          document.getElementById("selected_"+concatItem).innerHTML = tableValue;
                     } 
                     
                 } else if(scale == "global-level"){
                    // add item info to panel
                    //TO DO
                 }

            }
        }    
        return uniqueFeatures;
    }
    
    function populateWorldTotals(){
        
        // get data vaues for whole world
        const globalFeatures = map.querySourceFeatures("composite", {
            sourceLayer: "WilsonMinerals4-0hbtuj",
        });
        console.log(globalFeatures)
        getUniqueFeatures(globalFeatures, "global-level");
        
    }
    
</script>

</body>
</html>